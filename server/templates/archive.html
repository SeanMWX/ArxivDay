<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{{ title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: #f0f0f2;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: left;
            padding: 20px;
            min-height: calc(100vh - 60px);
            line-height: 1.5;
        }
        .inner-content {
            max-width: 1200px;
            width: 100%;
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        a {
            color: #007bff;
            text-decoration: none;
        }
        a:hover { color: #0056b3; text-decoration: underline; }
        .article-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .article-left, .article-right { width: 48%; }
        .article-title, .article-summary { margin: 5px 0; }
        .favorite-btn {
            margin-top: 8px;
            padding: 6px 10px;
            border: 1px solid #007bff;
            background: #fff;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
            transition: all .2s;
        }
        button {
            margin-right: 8px;
            padding: 6px 10px;
            border: 1px solid #007bff;
            background: #fff;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
        }
        button.danger {
            border-color: #d9534f;
            color: #d9534f;
        }
        .favorite-btn.active {
            background: #ffd700;
            border-color: #e0b200;
            color: #000;
        }
        .tag-input, .note-input {
            width: 100%;
            box-sizing: border-box;
            margin-top: 6px;
            padding: 6px;
        }
        .filters {
            margin: 10px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .filters input, .filters select {
            padding: 6px 8px;
        }
        .bulk-actions {
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .bulk-actions input[type="text"] {
            padding: 6px 8px;
        }
        .select-chk {
            margin-right: 8px;
        }
        .article-container {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }
        .article-left, .article-right { width: 48%; }
        .article-title, .article-summary { margin: 5px 0; }
        textarea {
            width: 100%;
            min-height: 120px;
            margin-top: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="content">
        <h1>Archived</h1>
        <p><a href="/">Index</a> | <a href="/articles">Articles</a> | <a href="/calendar">Calendar</a> | <a href="/favorites">Favorites</a> | <a href="/storage">Storage</a></p>
        <div class="inner-content filters">
            <input id="searchInput" type="text" placeholder="搜索标题/摘要/作者/中文" />
            <input id="tagFilter" type="text" placeholder="按标签过滤（逗号分隔）" />
            <select id="sortSelect">
                <option value="updated_desc">按更新时间（新→旧）</option>
                <option value="updated_asc">按更新时间（旧→新）</option>
                <option value="title_asc">标题 A→Z</option>
            </select>
        </div>
        <div class="inner-content bulk-actions">
            <span>已选：<span id="selectedCount">0</span></span>
            <button id="bulkUnarchive" type="button">移出归档</button>
            <button id="bulkDelete" type="button" class="danger">删除选中</button>
            <input id="bulkTagInput" type="text" placeholder="添加标签到选中（单个标签）" />
            <button id="bulkTagBtn" type="button">应用标签</button>
        </div>
        <div class="inner-content">
            <div id="archivedList"></div>
        </div>
    </div>
    <script>
        const FAVORITES_KEY = 'arxivFavorites';
        const state = {
            search: '',
            tagFilter: '',
            sort: 'updated_desc',
            selected: new Set(),
        };

        function loadFavorites() {
            try {
                return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]');
            } catch (e) {
                return [];
            }
        }

        function saveFavorites(list) {
            localStorage.setItem(FAVORITES_KEY, JSON.stringify(list));
        }

        function escapeHTML(str) {
            return (str || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlight(text, term) {
            if (!term) return escapeHTML(text);
            const safe = escapeHTML(text);
            const regex = new RegExp(`(${escapeRegex(term)})`, 'gi');
            return safe.replace(regex, '<mark>$1</mark>');
        }

        function applyFilters(list) {
            const s = state.search.trim().toLowerCase();
            const tags = state.tagFilter.split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
            let filtered = list.filter(it => it.archived);

            if (s) {
                filtered = filtered.filter(it => {
                    const fields = [it.title, it.CN_title, it.summary, it.CN_summary, it.authors].map(v => (v || '').toLowerCase());
                    return fields.some(v => v.includes(s));
                });
            }

            if (tags.length) {
                filtered = filtered.filter(it => {
                    const itemTags = (it.tags || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
                    return tags.every(t => itemTags.includes(t));
                });
            }

            filtered.sort((a, b) => {
                if (state.sort === 'updated_desc' || state.sort === 'updated_asc') {
                    const da = a.updated ? new Date(a.updated).getTime() : 0;
                    const db = b.updated ? new Date(b.updated).getTime() : 0;
                    return state.sort === 'updated_desc' ? db - da : da - db;
                }
                if (state.sort === 'title_asc') {
                    return (a.title || '').localeCompare(b.title || '');
                }
                return 0;
            });
            return filtered;
        }

        function renderArchived() {
            const list = applyFilters(loadFavorites());
            const container = document.getElementById('archivedList');
            if (!list.length) {
                container.innerHTML = '<p>暂无归档内容。</p>';
                return;
            }
            container.innerHTML = '';
            list.forEach((item) => {
                const div = document.createElement('div');
                div.className = 'article-container';
                const entryId = item.entry_id;
                const updated = item.updated ? new Date(item.updated).toLocaleString() : '';
                div.innerHTML = `
                    <div class="article-left">
                        <input type="checkbox" class="select-chk" data-entry-id="${entryId}" ${state.selected.has(entryId) ? 'checked' : ''}>
                        <h3 class="article-title">${highlight(item.title || entryId, state.search)}</h3>
                        <p class="article-summary">${highlight(item.summary || '', state.search)}</p>
                        <p><i>Updated: ${updated}</i></p>
                    </div>
                    <div class="article-right">
                        <h3 class="article-title">标题: ${highlight(item.CN_title || '', state.search)}</h3>
                        <p class="article-summary">摘要: ${highlight(item.CN_summary || '', state.search)}</p>
                        <p><i>更新时间: ${updated}</i></p>
                        <p><i>领域: ${item.categories || ''}</i></p>
                        <p><i>下载: <a href="${entryId}" target="_blank">${entryId}</a></i></p>
                        <label>标签(逗号分隔): <input class="tag-input" type="text" value="${item.tags || ''}" data-entry-id="${entryId}"></label>
                        <label>笔记:<textarea class="note-input" data-entry-id="${entryId}">${item.note || ''}</textarea></label>
                        <button class="favorite-btn" type="button" data-entry-id="${entryId}">移出归档</button>
                        <button class="favorite-btn" type="button" data-entry-id="${entryId}" data-remove="1">删除</button>
                    </div>
                `;
                container.appendChild(div);
            });

            container.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const entryId = btn.dataset.entryId;
                    let listNow = loadFavorites();
                    const target = listNow.find(it => it.entry_id === entryId);
                    if (!target) return;
                    if (btn.dataset.remove === '1') {
                        listNow = listNow.filter(it => it.entry_id !== entryId);
                    } else {
                        target.archived = false;
                    }
                    state.selected.delete(entryId);
                    saveFavorites(listNow);
                    renderArchived();
                    updateSelectedCount();
                });
            });

            container.querySelectorAll('.tag-input, .note-input').forEach(input => {
                input.addEventListener('change', () => {
                    const entryId = input.dataset.entryId;
                    const listNow = loadFavorites();
                    const target = listNow.find(it => it.entry_id === entryId);
                    if (target) {
                        target.tags = container.querySelector(`.tag-input[data-entry-id="${entryId}"]`)?.value.trim() || '';
                        target.note = container.querySelector(`.note-input[data-entry-id="${entryId}"]`)?.value.trim() || '';
                        saveFavorites(listNow);
                    }
                });
            });

            container.querySelectorAll('.select-chk').forEach(chk => {
                chk.addEventListener('change', (e) => {
                    const id = chk.dataset.entryId;
                    if (e.target.checked) {
                        state.selected.add(id);
                    } else {
                        state.selected.delete(id);
                    }
                    updateSelectedCount();
                });
            });

            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').innerText = state.selected.size;
        }

        function bulkUnarchive() {
            if (!state.selected.size) return;
            const list = loadFavorites();
            list.forEach(it => {
                if (state.selected.has(it.entry_id)) {
                    it.archived = false;
                }
            });
            state.selected.clear();
            saveFavorites(list);
            renderArchived();
            updateSelectedCount();
        }

        function bulkDelete() {
            if (!state.selected.size) return;
            if (!confirm('确定删除选中归档？')) return;
            let list = loadFavorites();
            list = list.filter(it => !state.selected.has(it.entry_id));
            state.selected.clear();
            saveFavorites(list);
            renderArchived();
            updateSelectedCount();
        }

        function bulkTag() {
            const tag = document.getElementById('bulkTagInput').value.trim();
            if (!tag || !state.selected.size) return;
            const list = loadFavorites();
            list.forEach(it => {
                if (state.selected.has(it.entry_id)) {
                    const tags = (it.tags || '').split(',').map(t => t.trim()).filter(Boolean);
                    if (!tags.includes(tag)) tags.push(tag);
                    it.tags = tags.join(', ');
                }
            });
            saveFavorites(list);
            renderArchived();
        }

        // Filter/sort bindings
        document.getElementById('searchInput').addEventListener('input', (e) => {
            state.search = e.target.value;
            renderArchived();
        });
        document.getElementById('tagFilter').addEventListener('input', (e) => {
            state.tagFilter = e.target.value;
            renderArchived();
        });
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            state.sort = e.target.value;
            renderArchived();
        });

        document.getElementById('bulkUnarchive').addEventListener('click', bulkUnarchive);
        document.getElementById('bulkDelete').addEventListener('click', bulkDelete);
        document.getElementById('bulkTagBtn').addEventListener('click', bulkTag);

        renderArchived();
    </script>
</body>
</html>
